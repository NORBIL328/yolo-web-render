<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Web Client-Side</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px;
        }

        h1 { margin-bottom: 20px; }

        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
            background-color: #000;
            border: 4px solid #ecf0f1;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Video oculto (fuente cruda) */
        #webcamVideo { display: none; }
        
        /* Canvas oculto (para procesar imagen) */
        #captureCanvas { display: none; }

        /* Imagen de salida (respuesta del servidor) */
        #outputImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none; /* Oculto al inicio */
        }

        /* Texto de estado cuando está apagado */
        #placeholderText {
            color: #7f8c8d;
            font-size: 1.5rem;
        }

        /* Botón */
        button {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .btn-start {
            background-color: #27ae60;
            color: white;
        }
        .btn-start:hover { background-color: #2ecc71; transform: scale(1.05); }

        .btn-stop {
            background-color: #c0392b;
            color: white;
        }
        .btn-stop:hover { background-color: #e74c3c; transform: scale(1.05); }

        .status { margin-top: 15px; font-size: 14px; color: #bdc3c7; }
    </style>
</head>
<body>
    <h1>Detección YOLO - Cliente Web</h1>

    <div class="video-container">
        <video id="webcamVideo" autoplay playsinline></video>
        <canvas id="captureCanvas" width="640" height="480"></canvas>

        <span id="placeholderText">Cámara Apagada</span>
        <img id="outputImage" alt="Procesamiento YOLO">
    </div>

    <button id="toggleBtn" class="btn-start" onclick="toggleCamera()">Encender Cámara</button>
    
    <div class="status" id="statusText">Estado: Inactivo</div>
    <script>
        const video = document.getElementById('webcamVideo');
        const canvas = document.getElementById('captureCanvas');
        const ctx = canvas.getContext('2d');
        const outputImg = document.getElementById('outputImage');
        const placeholder = document.getElementById('placeholderText');
        const btn = document.getElementById('toggleBtn');
        const statusText = document.getElementById('statusText');

        let isStreaming = false;
        let localStream = null;
        async function toggleCamera() {
            if (!isStreaming) {
                // --- ENCENDER ---
                try {
                    statusText.innerText = "Solicitando permiso de cámara...";
                    
                    // 1. Pedir acceso a la webcam
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = localStream;
                    
                    // Esperar a que el video cargue metadata para saber su tamaño real (opcional)
                    video.onloadedmetadata = () => {
                        isStreaming = true;
                        
                        // Actualizar UI
                        placeholder.style.display = 'none';
                        outputImg.style.display = 'block';
                        btn.textContent = "Apagar Cámara";
                        btn.className = "btn-stop";
                        statusText.innerText = "Estado: Detectando (Enviando al servidor)...";

                        // Iniciar el bucle de envío
                        sendFrameLoop();
                    };

                } catch (err) {
                    console.error("Error:", err);
                    statusText.innerText = "Error: No se pudo acceder a la cámara. Revisa los permisos.";
                    alert("Por favor permite el acceso a la cámara para continuar.");
                }
            } else {
                // --- APAGAR ---
                isStreaming = false;
                statusText.innerText = "Deteniendo...";
                // 1. Detener todos los 'tracks' de video (apaga la luz de la webcam)
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                video.srcObject = null;

                // 2. Limpiar UI
                outputImg.src = ""; // Limpiar la última imagen recibida
                outputImg.style.display = 'none';
                placeholder.style.display = 'block';
                
                btn.textContent = "Encender Cámara";
                btn.className = "btn-start";
                statusText.innerText = "Estado: Inactivo";
            }
        }
        function sendFrameLoop() {
            // Si el usuario apagó, detenemos el bucle
            if (!isStreaming) return;

            // 1. Dibujar el frame actual del video en el canvas
            // Ajustamos el tamaño del canvas si fuera necesario, aquí lo forzamos a 640x480
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 2. Convertir canvas a Blob (JPG)
            canvas.toBlob((blob) => {
                if (!blob || !isStreaming) return;

                const formData = new FormData();
                formData.append('image', blob, 'frame.jpg');

                // 3. Enviar al Backend (Python)
                fetch('/detect', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (isStreaming) {
                        // 4. Actualizar la imagen con la respuesta (Base64)
                        outputImg.src = 'data:image/jpeg;base64,' + data.image;
                        
                        // Solicitar el siguiente frame lo más rápido posible (o usar setTimeout para controlar FPS)
                        requestAnimationFrame(sendFrameLoop);
                    }
                })
                .catch(err => {
                    console.error("Error de red:", err);
                    // Si hay error (ej. servidor caído), intentamos reconectar en 1 segundo
                    if (isStreaming) setTimeout(sendFrameLoop, 1000);
                });

            }, 'image/jpeg', 0.7); // Calidad 0.7 para mayor velocidad en internet
        }
    </script>
</body>
</html>
